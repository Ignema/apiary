"""{{ model.name }} API - Generated by Apiary"""

from contextlib import asynccontextmanager
from typing import Annotated, Optional
from fastapi import FastAPI, Depends, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from sqlmodel import Session, select
from database import engine, get_session, create_db_and_tables
from models import {{ model.models | map(attribute='name') | join(', ') }}

SessionDep = Annotated[Session, Depends(get_session)]


@asynccontextmanager
async def lifespan(app: FastAPI):
    """Initialize database on startup."""
    create_db_and_tables()
    yield


app = FastAPI(
    title="{{ model.name }}",
    version="{{ model.version }}",
    description="Generated REST API using Apiary MDE toolkit",
    lifespan=lifespan
)

# Configure CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
{% for endpoint in model.endpoints %}
{%- set model_name = endpoint.response_model | replace('[]', '') %}
{%- set model_lower = model_name | lower %}
{%- set path_param = endpoint.path_params[0] if endpoint.path_params else 'id' %}

{% if endpoint.method.value == 'GET' and not endpoint.path_params %}
@app.get("{{ model.base_url }}{{ endpoint.path }}", response_model=list[{{ model_name }}])
def list_{{ model_lower }}s(session: SessionDep):
    """{{ endpoint.description or 'List all ' + model_lower + 's' }}"""
    return session.exec(select({{ model_name }})).all()
{% elif endpoint.method.value == 'GET' and endpoint.path_params %}
@app.get("{{ model.base_url }}{{ endpoint.path }}", response_model={{ model_name }})
def get_{{ model_lower }}({{ path_param }}: int, session: SessionDep):
    """{{ endpoint.description or 'Get a single ' + model_lower }}"""
    {{ model_lower }} = session.get({{ model_name }}, {{ path_param }})
    if not {{ model_lower }}:
        raise HTTPException(status_code=404, detail="{{ model_name }} not found")
    return {{ model_lower }}
{% elif endpoint.method.value == 'POST' %}
@app.post("{{ model.base_url }}{{ endpoint.path }}", response_model={{ model_name }})
def create_{{ model_lower }}({{ model_lower }}: {{ endpoint.request_model or model_name }}, session: SessionDep):
    """{{ endpoint.description or 'Create a new ' + model_lower }}"""
    db_{{ model_lower }} = {{ model_name }}.model_validate({{ model_lower }})
    session.add(db_{{ model_lower }})
    session.commit()
    session.refresh(db_{{ model_lower }})
    return db_{{ model_lower }}
{% elif endpoint.method.value == 'PATCH' and endpoint.path_params %}
@app.patch("{{ model.base_url }}{{ endpoint.path }}", response_model={{ model_name }})
def update_{{ model_lower }}({{ path_param }}: int, {{ model_lower }}_update: {{ endpoint.request_model or model_name }}, session: SessionDep):
    """{{ endpoint.description or 'Update a ' + model_lower }}"""
    db_{{ model_lower }} = session.get({{ model_name }}, {{ path_param }})
    if not db_{{ model_lower }}:
        raise HTTPException(status_code=404, detail="{{ model_name }} not found")
    
    {{ model_lower }}_data = {{ model_lower }}_update.model_dump(exclude_unset=True)
    db_{{ model_lower }}.sqlmodel_update({{ model_lower }}_data)
    session.add(db_{{ model_lower }})
    session.commit()
    session.refresh(db_{{ model_lower }})
    return db_{{ model_lower }}

{% elif endpoint.method.value == 'PUT' and endpoint.path_params %}
@app.put("{{ endpoint.path }}", response_model={{ model_name }})
def replace_{{ model_lower }}({{ path_param }}: int, {{ model_lower }}: {{ endpoint.request_model or model_name }}, session: SessionDep):
    """{{ endpoint.description or 'Replace a ' + model_lower }}"""
    db_{{ model_lower }} = session.get({{ model_name }}, {{ path_param }})
    if not db_{{ model_lower }}:
        raise HTTPException(status_code=404, detail="{{ model_name }} not found")
    
    {{ model_lower }}_data = {{ model_lower }}.model_dump()
    db_{{ model_lower }}.sqlmodel_update({{ model_lower }}_data)
    session.add(db_{{ model_lower }})
    session.commit()
    session.refresh(db_{{ model_lower }})
    return db_{{ model_lower }}
{% elif endpoint.method.value == 'DELETE' and endpoint.path_params %}
@app.delete("{{ model.base_url }}{{ endpoint.path }}")
def delete_{{ model_lower }}({{ path_param }}: int, session: SessionDep):
    """{{ endpoint.description or 'Delete a ' + model_lower }}"""
    {{ model_lower }} = session.get({{ model_name }}, {{ path_param }})
    if not {{ model_lower }}:
        raise HTTPException(status_code=404, detail="{{ model_name }} not found")
    session.delete({{ model_lower }})
    session.commit()
    return {"deleted": True}
{% endif %}
{%- endfor %}

@app.get("/")
def root():
    """Root endpoint with API information."""
    return {
        "name": "{{ model.name }}",
        "version": "{{ model.version }}",
        "docs": "{{ model.base_url }}/docs",
        "redoc": "{{ model.base_url }}/redoc"
    }
